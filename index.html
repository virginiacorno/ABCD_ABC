<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | ABCD_unity</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body style="text-align: center; padding: 0; border: 0; margin: 0;">
    <canvas id="unity-canvas" width=1920 height=1080 tabindex="-1" style="width: 1920px; height: 1080px; background: #231F20"></canvas>

    <script>
    /* Early shim: provides SendDataToJS before Unity module loads.
       Once the .jslib plugin (UnityDataBridge) is active inside the
       Emscripten module it will handle calls natively; this shim
       covers the window between page-load and module-ready. */
    (function(){
      if (typeof window.SendDataToJS !== 'undefined') {
        console.log('[Shim] SendDataToJS already present');
        return;
      }
      window.SendDataToJS = function(payload) {
        try {
          var s = typeof payload === 'string' ? payload : JSON.stringify(payload);
          console.log('[WEBGL_DATA] ' + s);
          try {
            var obj = JSON.parse(s);
            window.parent.postMessage({ type: 'UNITY_DATA', data: obj }, '*');
          } catch (e) {
            window.parent.postMessage({ type: 'UNITY_DATA', data: s }, '*');
          }
        } catch (e) {
          console.error('[Shim] SendDataToJS error', e);
        }
      };
      console.log('[Shim] SendDataToJS installed');
    })();
    </script>

    <script src="Build/ABCD_git.loader.js"></script>
    <script>
      var unityInstance = null; // globally accessible for postMessage handler

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);

        var canvas = document.querySelector("#unity-canvas");
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";

        document.body.style.textAlign = "left";
      }

      createUnityInstance(document.querySelector("#unity-canvas"), {
        arguments: [],
        dataUrl: "Build/ABCD_git.data",
        frameworkUrl: "Build/ABCD_git.framework.js",
        codeUrl: "Build/ABCD_git.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "ABCD_unity",
        productVersion: "0.1.0",
        // matchWebGLToCanvasSize: false, // Uncomment this to separately control WebGL canvas render size and DOM element size.
        // devicePixelRatio: 1, // Uncomment this to override low DPI rendering on high DPI displays.
      }).then((instance) => {
        unityInstance = instance;
        console.log('[Unity] Instance ready');
      }).catch((message) => {
        alert(message);
      });

      /* === PostMessage handler: receive participant info from Pavlovia parent === */
      window.addEventListener('message', function(event) {
        console.log('[Unity iframe] Received message:', event.data);

        if (event.data && event.data.type === 'SET_PARTICIPANT') {
          var payload = event.data.payload;
          console.log('[Unity iframe] Setting participant info:', payload);

          var trySetInfo = function() {
            if (unityInstance) {
              try {
                unityInstance.SendMessage('DataLogger', 'SetParticipantInfo', payload);
                console.log('[Unity iframe] Successfully sent participant info to Unity');
              } catch (e) {
                console.error('[Unity iframe] Failed to send to Unity:', e);
              }
            } else {
              console.log('[Unity iframe] Unity not ready, retrying in 500ms...');
              setTimeout(trySetInfo, 500);
            }
          };
          trySetInfo();
        }
      });

      /* === Console-log interceptor: forward completion + data events to parent === */
      (function(){
        var targetOrigin = '*';
        var originalLog = console.log.bind(console);
        var doneSent = false;

        console.log = function() {
          var args = Array.prototype.slice.call(arguments);
          try {
            originalLog.apply(console, args);

            if (doneSent) return;

            var text = args.map(function(a) {
              return typeof a === 'object' ? JSON.stringify(a) : String(a);
            }).join(' ');

            // Detect task completion
            if (text.indexOf('All configurations completed!') !== -1 ||
                text.indexOf('FinishAllConfigurations: all configs completed.') !== -1 ||
                text.indexOf('ABCD_DONE') !== -1) {
              doneSent = true;
              try { window.parent.postMessage('ABCD_DONE', targetOrigin); } catch (e) {}
              originalLog('[postMessage bridge] ABCD_DONE sent to parent.');
            }

            // Forward WEBGL_DATA logs to parent
            if (text.indexOf('[WEBGL_DATA]') !== -1) {
              try {
                var jsonStart = text.indexOf('{');
                if (jsonStart !== -1) {
                  var jsonStr = text.substring(jsonStart);
                  var data = JSON.parse(jsonStr);
                  window.parent.postMessage({ type: 'UNITY_DATA', data: data }, targetOrigin);
                  originalLog('[Unity -> Parent] Sent data event:', data.event_type);
                }
              } catch (e) {
                originalLog('[Unity -> Parent] Failed to parse/send data:', e);
              }
            }
          } catch (e) {
            try { originalLog('console wrapper error', e); } catch (_) {}
          }
        };
      })();
    </script>
  </body>
</html>
